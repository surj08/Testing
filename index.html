<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golf Group Organizer V3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style for active tab */
        .tab.active {
            border-bottom-color: #3b82f6; /* Blue */
            font-weight: 600;
            color: #3b82f6;
        }
        /* Style for Player Management tab (always visible) */
        .tab-manage-players {
             border-bottom-color: #6b7280; /* Gray */
             color: #1f2937; /* Darker Gray */
        }
         .tab-manage-players.active {
             border-bottom-color: #10b981; /* Emerald */
             font-weight: 600;
             color: #10b981;
         }

        /* Style for tab hover */
        .tab:not(.active):hover {
            border-bottom-color: #d1d5db;
            color: #6b7280;
        }
        /* Sliders */
        input[type=range] {
            -webkit-appearance: none; appearance: none; width: 100%; height: 8px;
            background: #d1d5db; outline: none; opacity: 0.7; transition: opacity .2s;
            border-radius: 9999px;
        }
        input[type=range]:hover { opacity: 1; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 20px; height: 20px;
            background: #3b82f6; cursor: pointer; border-radius: 50%;
        }
        input[type=range]::-moz-range-thumb {
            width: 20px; height: 20px; background: #3b82f6; cursor: pointer;
            border-radius: 50%; border: none;
        }
        /* Animations and Hover Effects */
        .group-card, .player-item { transition: all 0.2s ease-in-out; }
        .player-item:hover { background-color: #f3f4f6; }
        /* Search results */
        #search-results {
            max-height: 150px; overflow-y: auto; border: 1px solid #d1d5db;
            border-top: none; border-radius: 0 0 0.375rem 0.375rem; background-color: white;
            position: absolute; width: 100%; /* Adjusted width */
            z-index: 10; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .search-result-item { padding: 0.5rem 0.75rem; cursor: pointer; }
        .search-result-item:hover { background-color: #eff6ff; }

        /* Inline Skill Bar (Player List) */
        .inline-skill-bar-container {
            display: inline-block;
            width: 50px; /* Fixed width for the bar container */
            height: 10px; /* Height of the bar */
            background-color: #e5e7eb; /* Light gray background */
            border-radius: 5px;
            overflow: hidden;
            margin-left: 8px;
            vertical-align: middle;
        }
        .inline-skill-bar {
            height: 100%;
            background-color: #60a5fa; /* Blue bar */
            border-radius: 5px 0 0 5px; /* Rounded left edge */
            transition: width 0.3s ease-in-out;
        }

         /* Group Total Skill Bar */
        .group-skill-bar-container {
            width: 100%; height: 12px; background-color: #e5e7eb;
            border-radius: 6px; overflow: hidden; margin-top: 8px;
        }
        .group-skill-bar {
            height: 100%; background-color: #34d399; /* Emerald bar */
            border-radius: 6px 0 0 6px; transition: width 0.3s ease-in-out;
            text-align: right; padding-right: 5px;
            font-size: 0.65rem; line-height: 12px; color: white; font-weight: 600;
        }
        /* Tooltip (shared) */
         .tooltip-container { position: relative; display: inline-block; }
         .tooltiptext {
            visibility: hidden; width: max-content; background-color: #374151; color: #fff;
            text-align: center; border-radius: 6px; padding: 5px 8px; position: absolute;
            z-index: 1; bottom: 125%; left: 50%; transform: translateX(-50%);
            opacity: 0; transition: opacity 0.3s; font-size: 0.75rem; white-space: nowrap;
        }
        .tooltip-container:hover .tooltiptext { visibility: visible; opacity: 1; }

        /* Edit/Delete Icons */
        .icon-btn {
            cursor: pointer; margin-left: 4px; vertical-align: middle;
            display: inline-flex; align-items: center; justify-content: center;
             width: 18px; height: 18px; border-radius: 4px;
        }
         .icon-btn:hover { background-color: #e5e7eb; }
         .icon-btn svg { width: 12px; height: 12px; }
         .edit-icon { color: #6b7280; }
         .delete-icon { color: #ef4444; }
         .edit-icon:hover { color: #3b82f6; }
         .delete-icon:hover { color: #dc2626; }

         /* Player Management List Item */
         .mgmt-player-item {
             display: flex; justify-content: space-between; align-items: center;
             padding: 8px; border-bottom: 1px solid #eee;
         }
          .mgmt-player-item:last-child { border-bottom: none; }

    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <div class="max-w-6xl mx-auto bg-white rounded-lg shadow-md p-6">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Golf Group Organizer V3</h1>

        <div class="border-b border-gray-200 mb-6">
            <nav id="tabs" class="-mb-px flex space-x-4 overflow-x-auto pb-1" aria-label="Tabs">
                <button id="tab-manage-players-btn" class="tab tab-manage-players whitespace-nowrap py-3 px-3 border-b-2 text-sm font-medium rounded-t-md flex-shrink-0">
                    Manage Players
                 </button>
                <button id="add-outing-btn" class="flex-shrink-0 whitespace-nowrap py-3 px-3 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 rounded-t-md">
                    + Add Outing
                </button>
            </nav>
        </div>

        <div id="tab-content">

            <div id="outing-view" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1 space-y-6">
                        <div class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                            <h2 class="text-lg font-semibold text-gray-700 mb-3">Add Players to Outing</h2>
                            <div class="relative">
                                <label for="player-search" class="block text-sm font-medium text-gray-700 mb-1">Search Database</label>
                                <input type="text" id="player-search" placeholder="Start typing player name..." class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <div id="search-results" class="absolute left-0 right-0 mt-1 hidden"></div>
                            </div>
                            <div id="add-new-player-section" class="mt-4 pt-4 border-t border-gray-200 hidden">
                                <h3 class="text-md font-semibold text-gray-600 mb-2">Add New Player</h3>
                                <p class="text-sm mb-2">Player "<strong id="new-player-name-display"></strong>" not found.</p>
                                <div class="mb-3">
                                    <label for="new-player-skill" class="block text-sm font-medium text-gray-700 mb-1">Set Skill Level (<span id="new-skill-value">5</span>)</label>
                                    <input type="range" id="new-player-skill" min="1" max="10" value="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                </div>
                                <button id="add-new-player-btn" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                                    Add New Player to Database
                                </button>
                            </div>
                        </div>

                         <div class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                            <h2 class="text-lg font-semibold text-gray-700 mb-3">Players in this Outing</h2>
                            <div id="outing-player-list" class="mt-2 max-h-60 overflow-y-auto space-y-1 pr-2">
                                </div>
                        </div>
                    </div>

                    <div class="md:col-span-2 space-y-6">
                        <div class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                            <h2 class="text-lg font-semibold text-gray-700 mb-3">Configure Groups</h2>
                             <div class="flex flex-col md:flex-row md:items-center gap-4">
                                <div class="flex-grow">
                                     <label for="num-groups" class="block text-sm font-medium text-gray-700 mb-1">Number of Groups (<span id="groups-value">2</span>)</label>
                                    <input type="range" id="num-groups" min="1" max="10" value="2" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                </div>
                                 <button id="shake-up-btn" class="mt-2 md:mt-0 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out">
                                    Generate / Shake Up Groups
                                </button>
                             </div>
                        </div>

                        <div>
                            <h2 class="text-lg font-semibold text-gray-700 mb-3">Generated Groups</h2>
                            <div id="group-display" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                </div>
                        </div>
                    </div>
                </div>
            </div> <div id="player-management-view" class="hidden">
                 <h2 class="text-xl font-semibold text-gray-700 mb-4">Player Database Management</h2>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                     <div class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                         <h3 class="text-lg font-semibold text-gray-700 mb-3">Add Player to Database</h3>
                         <div class="space-y-3">
                             <div>
                                 <label for="mgmt-player-name" class="block text-sm font-medium text-gray-700">Player Name</label>
                                 <input type="text" id="mgmt-player-name" placeholder="Enter full name" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                             </div>
                             <div>
                                 <label for="mgmt-player-skill" class="block text-sm font-medium text-gray-700">Skill Level (<span id="mgmt-skill-value">5</span>)</label>
                                 <input type="range" id="mgmt-player-skill" min="1" max="10" value="5" class="mt-1 w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                             </div>
                             <button id="mgmt-add-player-btn" class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                                 Add Player
                             </button>
                         </div>
                     </div>
                     <div class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                         <h3 class="text-lg font-semibold text-gray-700 mb-3">All Players</h3>
                         <div id="all-players-list" class="max-h-96 overflow-y-auto space-y-1 pr-2">
                             </div>
                     </div>
                 </div>
            </div> <div id="message-area" class="mt-6 text-center font-medium"></div>

        </div> </div> <script>
        // --- DOM Elements ---
        const tabsContainer = document.getElementById('tabs');
        const managePlayersTabBtn = document.getElementById('tab-manage-players-btn');
        const addOutingBtn = document.getElementById('add-outing-btn');
        const outingViewDiv = document.getElementById('outing-view');
        const playerManagementViewDiv = document.getElementById('player-management-view');
        // Outing View Elements
        const playerSearchInput = document.getElementById('player-search');
        const searchResultsDiv = document.getElementById('search-results');
        const addNewPlayerSection = document.getElementById('add-new-player-section');
        const newPlayerNameDisplay = document.getElementById('new-player-name-display');
        const newPlayerSkillSlider = document.getElementById('new-player-skill');
        const newSkillValueSpan = document.getElementById('new-skill-value');
        const addNewPlayerBtn = document.getElementById('add-new-player-btn');
        const outingPlayerListDiv = document.getElementById('outing-player-list');
        const numGroupsSlider = document.getElementById('num-groups');
        const groupsValueSpan = document.getElementById('groups-value');
        const shakeUpBtn = document.getElementById('shake-up-btn');
        const groupDisplayDiv = document.getElementById('group-display');
        // Player Management View Elements
        const mgmtPlayerNameInput = document.getElementById('mgmt-player-name');
        const mgmtPlayerSkillSlider = document.getElementById('mgmt-player-skill');
        const mgmtSkillValueSpan = document.getElementById('mgmt-skill-value');
        const mgmtAddPlayerBtn = document.getElementById('mgmt-add-player-btn');
        const allPlayersListDiv = document.getElementById('all-players-list');
        // Global Elements
        const messageArea = document.getElementById('message-area');

        // --- Application State ---
        let allPlayers = {}; // Central DB: { "lowercase name": { name: "Proper Name", skill: 5 } }
        let outings = {}; // { outingId: { name: "Outing Name", playerNames: ["lowercase name"], numberOfGroups: 2, groups: [] } }
        let activeOutingId = null; // ID of the currently active outing tab
        let currentViewMode = 'outing'; // 'outing' or 'playerManagement'
        let nextOutingIndex = 1;

        // --- Constants ---
        const PLAYER_MGMT_VIEW_ID = 'playerManagement'; // Special ID for the management view

        // --- Initialization ---
        function initializeApp() {
            loadData();
            setupEventListeners();
            renderTabs(); // Render static + dynamic tabs
            // Determine initial view
            if (Object.keys(outings).length > 0) {
                // Activate the first outing if available
                const firstOutingId = Object.keys(outings).sort((a, b) => outings[a].name.localeCompare(outings[b].name))[0];
                setActiveView(firstOutingId);
            } else {
                // If no outings, default to player management view
                setActiveView(PLAYER_MGMT_VIEW_ID);
            }
        }

        // --- Data Persistence ---
        function saveData() {
            localStorage.setItem('golfOrganizerDataV3', JSON.stringify({ allPlayers, outings, nextOutingIndex }));
             console.log("Data saved:", { allPlayers, outings, nextOutingIndex });
        }

        function loadData() {
            const savedData = localStorage.getItem('golfOrganizerDataV3');
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                allPlayers = parsedData.allPlayers || {};
                outings = parsedData.outings || {};
                nextOutingIndex = parsedData.nextOutingIndex || 1;
                // Data integrity checks
                Object.values(outings).forEach(outing => {
                    outing.playerNames = outing.playerNames || [];
                    outing.numberOfGroups = outing.numberOfGroups || 2;
                    outing.groups = outing.groups || [];
                });
                // Ensure keys are lowercase and structure is correct
                const correctedPlayers = {};
                Object.values(allPlayers).forEach(player => {
                    if (player && player.name) {
                         correctedPlayers[player.name.toLowerCase()] = player;
                    }
                });
                allPlayers = correctedPlayers;
                 console.log("Data loaded:", { allPlayers, outings, nextOutingIndex });
            } else {
                 allPlayers = {}; outings = {}; nextOutingIndex = 1;
                 console.log("No saved data found, initializing empty state.");
            }
        }

        // --- View Management ---
        function setActiveView(id) {
            clearMessage();
            playerSearchInput.value = ''; // Clear search always
            hideSearchResults();
            hideAddNewPlayerSection();

            if (id === PLAYER_MGMT_VIEW_ID) {
                currentViewMode = 'playerManagement';
                activeOutingId = null; // No outing is active
                outingViewDiv.classList.add('hidden');
                playerManagementViewDiv.classList.remove('hidden');
                renderPlayerManagementView();
            } else if (outings[id]) {
                currentViewMode = 'outing';
                activeOutingId = id;
                outingViewDiv.classList.remove('hidden');
                playerManagementViewDiv.classList.add('hidden');
                updateOutingViewUI(); // Update UI for the selected outing
            } else {
                console.error("Attempted to activate invalid view/outing ID:", id);
                // Fallback: Go to player management if outing ID is invalid
                setActiveView(PLAYER_MGMT_VIEW_ID);
                return; // Prevent further execution with invalid state
            }
            highlightActiveTab(id); // Update tab highlighting
        }

        // --- Tab Management ---
        function highlightActiveTab(activeId) {
             // Deactivate all tabs first
            tabsContainer.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            managePlayersTabBtn.classList.remove('active'); // Specifically for the static tab

             // Activate the correct tab
             if (activeId === PLAYER_MGMT_VIEW_ID) {
                 managePlayersTabBtn.classList.add('active');
             } else {
                 const activeTabButton = tabsContainer.querySelector(`.tab[data-outing-id="${activeId}"]`);
                 if (activeTabButton) {
                     activeTabButton.classList.add('active');
                 }
             }
        }

        function renderTabs() {
            // Clear only dynamic outing tabs
            tabsContainer.querySelectorAll('.outing-tab').forEach(tab => tab.remove());

            // Render outing tabs
            Object.keys(outings).sort((a, b) => outings[a].name.localeCompare(outings[b].name)).forEach(outingId => {
                const outing = outings[outingId];
                const tabButton = document.createElement('button');
                // Add 'outing-tab' class for easy selection/removal
                tabButton.className = 'tab outing-tab whitespace-nowrap py-3 px-3 border-b-2 border-transparent text-sm font-medium text-gray-500 rounded-t-md flex-shrink-0 flex items-center';
                tabButton.dataset.outingId = outingId;

                // Outing Name Span (for potential inline editing later if desired)
                const nameSpan = document.createElement('span');
                nameSpan.textContent = outing.name;
                tabButton.appendChild(nameSpan);

                // Edit Button
                const editBtn = document.createElement('span');
                editBtn.className = 'icon-btn edit-icon ml-2'; // Added margin-left
                editBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg>`;
                editBtn.onclick = (event) => {
                    event.stopPropagation(); // Prevent tab switching
                    editOutingName(outingId);
                };
                tabButton.appendChild(editBtn);

                // Delete Button
                const deleteBtn = document.createElement('span');
                deleteBtn.className = 'icon-btn delete-icon';
                deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg>`;
                deleteBtn.onclick = (event) => {
                    event.stopPropagation();
                    if (confirm(`Are you sure you want to delete outing "${outing.name}"? Players won't be removed from the database.`)) {
                        deleteOuting(outingId);
                    }
                };
                tabButton.appendChild(deleteBtn);

                tabButton.addEventListener('click', () => setActiveView(outingId));
                tabsContainer.insertBefore(tabButton, addOutingBtn); // Insert before the "Add" button
            });

             // Re-apply active state after rendering
            highlightActiveTab(currentViewMode === 'playerManagement' ? PLAYER_MGMT_VIEW_ID : activeOutingId);
        }


        function createNewOuting() {
            const newOutingId = `outing-${Date.now()}-${Math.random().toString(16).slice(2)}`;
            const newOutingName = `Outing ${nextOutingIndex++}`;
            outings[newOutingId] = { name: newOutingName, playerNames: [], numberOfGroups: 2, groups: [] };
            saveData();
            renderTabs(); // Re-render tabs to include the new one
            setActiveView(newOutingId); // Switch to the new outing view
        }

         function editOutingName(outingId) {
             if (!outings[outingId]) return;
             const currentName = outings[outingId].name;
             const newName = prompt(`Enter new name for outing "${currentName}":`, currentName);

             if (newName && newName.trim() !== '' && newName.trim() !== currentName) {
                 outings[outingId].name = newName.trim();
                 saveData();
                 renderTabs(); // Re-render tabs to show the new name
                 // Active tab highlighting is handled by renderTabs calling highlightActiveTab
             } else if (newName !== null) { // User didn't cancel, but entered empty or same name
                 showMessage("Outing name cannot be empty or unchanged.", "error");
             }
         }


        function deleteOuting(outingIdToDelete) {
            if (!outings[outingIdToDelete]) return;
            delete outings[outingIdToDelete];

            // If the deleted outing was active, switch view
            if (activeOutingId === outingIdToDelete) {
                const remainingOutingIds = Object.keys(outings);
                if (remainingOutingIds.length > 0) {
                    // Activate the first remaining outing
                    setActiveView(remainingOutingIds.sort((a, b) => outings[a].name.localeCompare(outings[b].name))[0]);
                } else {
                    // No outings left, switch to player management view
                    setActiveView(PLAYER_MGMT_VIEW_ID);
                }
            }
            saveData();
            renderTabs(); // Update tab display (active highlighting is handled by setActiveView)
        }

        // --- Player Search and Add (Outing View) ---
        function handlePlayerSearch() {
            // Same logic as V2
            const searchTerm = playerSearchInput.value.trim().toLowerCase();
            searchResultsDiv.innerHTML = '';
            hideAddNewPlayerSection();

            if (!searchTerm) {
                hideSearchResults();
                return;
            }

            const matchingPlayers = Object.values(allPlayers)
                .filter(player => player.name.toLowerCase().includes(searchTerm))
                .sort((a, b) => a.name.localeCompare(b.name));

            if (matchingPlayers.length > 0) {
                matchingPlayers.forEach(player => {
                    const item = document.createElement('div');
                    item.classList.add('search-result-item');
                    item.textContent = `${player.name} (Skill: ${player.skill})`;
                    item.addEventListener('click', () => selectPlayerFromSearch(player.name));
                    searchResultsDiv.appendChild(item);
                });
                showSearchResults();
            } else {
                showAddNewPlayerSection(playerSearchInput.value.trim());
                hideSearchResults();
            }
        }

        function selectPlayerFromSearch(playerName) {
            // Same logic as V2
            addPlayerToCurrentOuting(playerName);
            playerSearchInput.value = '';
            hideSearchResults();
            hideAddNewPlayerSection();
            playerSearchInput.focus();
        }

        function showSearchResults() { searchResultsDiv.classList.remove('hidden'); }
        function hideSearchResults() { searchResultsDiv.classList.add('hidden'); searchResultsDiv.innerHTML = ''; }
        function showAddNewPlayerSection(nameAttempt) {
             if (!nameAttempt) return;
             newPlayerNameDisplay.textContent = nameAttempt;
             newPlayerSkillSlider.value = 5;
             newSkillValueSpan.textContent = '5';
             addNewPlayerSection.classList.remove('hidden');
        }
        function hideAddNewPlayerSection() { addNewPlayerSection.classList.add('hidden'); }

        function addNewPlayerFromOutingView() {
            // Adds player to DB *and* current outing
            const newName = newPlayerNameDisplay.textContent;
            const skill = parseInt(newPlayerSkillSlider.value, 10);

            const success = addPlayerToDatabase(newName, skill); // Use the central function

            if (success) {
                // If added successfully to DB, also add to current outing
                addPlayerToCurrentOuting(newName);
                playerSearchInput.value = ''; // Clear search bar
                hideAddNewPlayerSection();
                playerSearchInput.focus();
            }
            // addPlayerToDatabase handles messages
        }

        // --- Outing Player Management ---
         function addPlayerToCurrentOuting(playerName) {
             // Same logic as V2 - adds player *name* to outing list
             if (currentViewMode !== 'outing' || !activeOutingId || !outings[activeOutingId]) {
                 showMessage("Please select an active outing first.");
                 return;
             }
             const currentOuting = outings[activeOutingId];
             const playerNameLower = playerName.toLowerCase();
             const playerExists = allPlayers[playerNameLower];

             if (!playerExists) {
                  showMessage(`Player "${playerName}" not found. Add via 'Manage Players' tab or search again.`, "error");
                  return;
             }

             if (!currentOuting.playerNames.includes(playerNameLower)) {
                 currentOuting.playerNames.push(playerNameLower);
                 updateOutingPlayerList(); // Update the list display
                 generateAndDisplayGroups(); // Regenerate groups
                 saveData();
                 clearMessage();
             } else {
                  showMessage(`"${playerExists.name}" is already in this outing.`, 'info');
             }
         }

        function removePlayerFromOuting(playerName) {
            // Same logic as V2 - removes player *name* from outing list
             if (currentViewMode !== 'outing' || !activeOutingId || !outings[activeOutingId]) return;
             const currentOuting = outings[activeOutingId];
             const playerNameLower = playerName.toLowerCase();

            currentOuting.playerNames = currentOuting.playerNames.filter(name => name !== playerNameLower);
            updateOutingPlayerList();
            generateAndDisplayGroups(); // Regenerate groups
            saveData();
        }

        function updateOutingPlayerList() {
            // Renders players in the current outing list with inline skill bars
            outingPlayerListDiv.innerHTML = '';
             if (currentViewMode !== 'outing' || !activeOutingId || !outings[activeOutingId]) return;

            const currentOuting = outings[activeOutingId];

            if (currentOuting.playerNames.length === 0) {
                outingPlayerListDiv.innerHTML = '<p class="text-sm text-gray-500 italic">No players added. Use the search bar above.</p>';
                return;
            }

            const playersInOuting = currentOuting.playerNames
                .map(nameLower => allPlayers[nameLower])
                .filter(player => player) // Filter out inconsistencies
                .sort((a, b) => a.name.localeCompare(b.name));

            playersInOuting.forEach(player => {
                    const playerElement = document.createElement('div');
                    playerElement.classList.add('player-item', 'flex', 'justify-between', 'items-center', 'text-sm', 'p-1.5', 'rounded');

                    // Player Name, Skill Text, and Inline Bar
                    const nameSkillContainer = document.createElement('div');
                    nameSkillContainer.className = 'flex items-center';

                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = `${player.name} (Skill: ${player.skill})`;
                    nameSkillContainer.appendChild(nameSpan);

                    // Inline Skill Bar
                    const barContainer = document.createElement('div');
                    barContainer.className = 'inline-skill-bar-container tooltip-container'; // Add tooltip container class
                    const bar = document.createElement('div');
                    bar.className = 'inline-skill-bar';
                    const skillPercentage = (player.skill / 10) * 100; // Max skill is 10
                    bar.style.width = `${skillPercentage}%`;
                    barContainer.appendChild(bar);

                     // Tooltip for the bar
                    const tooltip = document.createElement('span');
                    tooltip.className = 'tooltiptext';
                    tooltip.textContent = `Skill: ${player.skill}/10`;
                    barContainer.appendChild(tooltip);


                    nameSkillContainer.appendChild(barContainer);
                    playerElement.appendChild(nameSkillContainer);

                    // Remove Button
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'icon-btn delete-icon flex-shrink-0'; // Use icon class
                    removeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>`; // Simple X icon
                    removeBtn.title = `Remove ${player.name} from this outing`;
                    removeBtn.onclick = () => removePlayerFromOuting(player.name);
                    playerElement.appendChild(removeBtn);

                    outingPlayerListDiv.appendChild(playerElement);
            });
        }


        // --- Player Database Management (New View Logic) ---

        // Central function to add/update player in the database
        function addPlayerToDatabase(name, skill) {
            const trimmedName = name.trim();
            const nameLower = trimmedName.toLowerCase();

            if (!trimmedName) {
                showMessage("Player name cannot be empty.", "error");
                return false; // Indicate failure
            }
             if (skill < 1 || skill > 10) {
                  showMessage("Skill must be between 1 and 10.", "error");
                  return false;
             }

            if (allPlayers[nameLower]) {
                // Player exists, update skill (optional, decide if this is desired behavior)
                // For now, let's prevent adding duplicates and require editing
                showMessage(`Player "${trimmedName}" already exists. Edit skill in 'Manage Players' tab.`, "error");
                 return false; // Or update: allPlayers[nameLower].skill = skill; showMessage('Skill updated', 'info'); return true;
            } else {
                // Add new player
                allPlayers[nameLower] = { name: trimmedName, skill: parseInt(skill, 10) };
                saveData();
                showMessage(`Player "${trimmedName}" added to database.`, "info");
                // If the management view is active, refresh its list
                if (currentViewMode === 'playerManagement') {
                    renderPlayerManagementView();
                }
                 // Clear the form in management view if it was used
                mgmtPlayerNameInput.value = '';
                mgmtPlayerSkillSlider.value = 5;
                mgmtSkillValueSpan.textContent = '5';

                return true; // Indicate success
            }
        }


        function renderPlayerManagementView() {
            allPlayersListDiv.innerHTML = ''; // Clear list
            mgmtPlayerNameInput.value = ''; // Clear form
            mgmtPlayerSkillSlider.value = 5;
            mgmtSkillValueSpan.textContent = '5';


            const sortedPlayers = Object.values(allPlayers).sort((a, b) => a.name.localeCompare(b.name));

            if (sortedPlayers.length === 0) {
                allPlayersListDiv.innerHTML = '<p class="text-sm text-gray-500 italic">No players in the database yet. Add one using the form.</p>';
                return;
            }

            sortedPlayers.forEach(player => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'mgmt-player-item'; // Use specific class for styling

                // Player Info (Name and Skill)
                const infoSpan = document.createElement('span');
                infoSpan.textContent = `${player.name} (Skill: ${player.skill})`;
                itemDiv.appendChild(infoSpan);

                // Action Buttons (Edit, Delete)
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'flex items-center space-x-2 flex-shrink-0'; // Ensure buttons don't wrap easily

                // Edit Button
                const editBtn = document.createElement('button');
                editBtn.className = 'icon-btn edit-icon';
                editBtn.title = `Edit ${player.name}'s skill`;
                editBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg>`;
                editBtn.onclick = () => editPlayerSkillFromMgmt(player.name);
                actionsDiv.appendChild(editBtn);

                // Delete Button
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'icon-btn delete-icon';
                deleteBtn.title = `Delete ${player.name} from database`;
                deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg>`;
                deleteBtn.onclick = () => deletePlayerFromDatabase(player.name);
                actionsDiv.appendChild(deleteBtn);

                itemDiv.appendChild(actionsDiv);
                allPlayersListDiv.appendChild(itemDiv);
            });
        }

        function handleAddPlayerFromMgmt() {
            const name = mgmtPlayerNameInput.value;
            const skill = parseInt(mgmtPlayerSkillSlider.value, 10);
            addPlayerToDatabase(name, skill); // This function handles saving and UI refresh
        }

        function editPlayerSkillFromMgmt(playerName) {
            const playerNameLower = playerName.toLowerCase();
            const player = allPlayers[playerNameLower];
            if (!player) return;

            const newSkill = prompt(`Enter new skill (1-10) for ${player.name}:`, player.skill);
            const parsedSkill = parseInt(newSkill, 10);

            if (newSkill !== null && !isNaN(parsedSkill) && parsedSkill >= 1 && parsedSkill <= 10) {
                if (parsedSkill !== player.skill) {
                    player.skill = parsedSkill;
                    allPlayers[playerNameLower] = player; // Update object
                    saveData();
                    showMessage(`Skill updated for ${player.name}.`, "info");
                    renderPlayerManagementView(); // Refresh the management list
                    // Also refresh the current outing list if the player is in it
                    if (currentViewMode === 'outing' && activeOutingId && outings[activeOutingId].playerNames.includes(playerNameLower)) {
                        updateOutingPlayerList();
                        generateAndDisplayGroups(); // Regenerate groups as skill changed
                    }
                }
            } else if (newSkill !== null) { // User didn't cancel, but entered invalid input
                showMessage("Invalid skill level. Please enter a number between 1 and 10.", "error");
            }
        }

        function deletePlayerFromDatabase(playerName) {
            const playerNameLower = playerName.toLowerCase();
            const player = allPlayers[playerNameLower];
            if (!player) return;

            if (confirm(`⚠️ Are you sure you want to DELETE "${player.name}" from the database?\n\nThis action cannot be undone and will remove the player from ALL outings.`)) {
                // 1. Remove from central database
                delete allPlayers[playerNameLower];

                // 2. Remove from all outings
                Object.keys(outings).forEach(outingId => {
                    outings[outingId].playerNames = outings[outingId].playerNames.filter(name => name !== playerNameLower);
                    // If the current outing view is active, regenerate its groups
                    if (currentViewMode === 'outing' && activeOutingId === outingId) {
                        outings[outingId].groups = []; // Clear groups as player list changed significantly
                    }
                });

                saveData();
                showMessage(`Player "${player.name}" deleted from database and all outings.`, "info");

                // Refresh the current view
                if (currentViewMode === 'playerManagement') {
                    renderPlayerManagementView();
                } else if (currentViewMode === 'outing' && activeOutingId) {
                    updateOutingViewUI(); // Refresh outing view completely
                }
            }
        }

        // --- Group Generation & Display ---
        function generateGroups() {
            // Core logic remains the same, but ensure players are fetched correctly
            clearMessage();
             if (currentViewMode !== 'outing' || !activeOutingId || !outings[activeOutingId]) {
                 showMessage("Cannot generate groups without an active outing selected.", "error");
                 return [];
             }

            const currentOuting = outings[activeOutingId];
            const playerNames = currentOuting.playerNames;
            let numGroups = currentOuting.numberOfGroups;

            const players = playerNames
                .map(nameLower => allPlayers[nameLower])
                .filter(player => player); // Fetch full player objects

            if (players.length === 0) {
                // showMessage("Add players to the outing before generating groups.");
                 currentOuting.groups = []; saveData(); return [];
            }
             if (numGroups <= 0) {
                  // showMessage("Number of groups must be at least 1.");
                  currentOuting.groups = []; saveData(); return [];
             }
             if (numGroups > players.length) {
                 showMessage(`Adjusting groups to match number of players (${players.length}).`, 'info');
                 numGroups = players.length;
                 currentOuting.numberOfGroups = numGroups;
                 numGroupsSlider.value = numGroups;
                 groupsValueSpan.textContent = numGroups;
             }

            const sortedPlayers = [...players].sort((a, b) => b.skill - a.skill);
            const groups = Array.from({ length: numGroups }, (_, i) => ({ id: i + 1, players: [], totalSkill: 0 }));

            sortedPlayers.forEach(player => {
                groups.sort((a, b) => a.totalSkill - b.totalSkill);
                groups[0].players.push(player);
                groups[0].totalSkill += player.skill;
            });

            currentOuting.groups = groups;
            saveData();
            return groups;
        }

        function displayGroups(groups) {
            // Updated to include total skill bar visualization
            groupDisplayDiv.innerHTML = '';

            if (!groups || groups.length === 0) {
                 if (currentViewMode === 'outing' && activeOutingId && outings[activeOutingId] && outings[activeOutingId].playerNames.length > 0) {
                     groupDisplayDiv.innerHTML = '<p class="text-gray-500 italic sm:col-span-2 lg:col-span-3">Click "Generate / Shake Up Groups" to create groups.</p>';
                 } else if (currentViewMode === 'outing') {
                      groupDisplayDiv.innerHTML = '<p class="text-gray-500 italic sm:col-span-2 lg:col-span-3">Add players to this outing first.</p>';
                 } else {
                      groupDisplayDiv.innerHTML = '<p class="text-gray-500 italic sm:col-span-2 lg:col-span-3">Select an outing or manage players.</p>';
                 }
                return;
            }

            // Find max total skill for scaling bars (or use a fixed reasonable max)
             let maxTotalSkill = 0;
             groups.forEach(group => {
                 if (group.totalSkill > maxTotalSkill) maxTotalSkill = group.totalSkill;
             });
             // Use a minimum max skill to prevent tiny bars for low-skill groups
             const scaleMax = Math.max(maxTotalSkill, 10 * (groups[0]?.players?.length || 1)); // Estimate based on max possible skill


            groups.sort((a, b) => a.id - b.id).forEach(group => {
                const groupCard = document.createElement('div');
                groupCard.classList.add('group-card', 'bg-white', 'p-4', 'rounded-lg', 'border', 'border-gray-200', 'shadow-sm', 'flex', 'flex-col'); // Flex column

                const avgSkill = group.players.length > 0 ? (group.totalSkill / group.players.length).toFixed(1) : 'N/A';

                let playerListHTML = group.players
                    .map(p => `<li class="text-sm text-gray-600">${p.name} (Skill: ${p.skill})</li>`)
                    .join('');
                 if (!playerListHTML) playerListHTML = '<li class="text-sm text-gray-400 italic">Empty</li>';

                // Group Info Div
                const infoDiv = document.createElement('div');
                infoDiv.innerHTML = `
                    <h3 class="text-md font-semibold text-blue-700 mb-1">Group ${group.id}</h3>
                    <p class="text-sm text-gray-500 mb-2">Avg Skill: ${avgSkill} | Total Skill: ${group.totalSkill}</p>
                    <ul class="space-y-1 list-disc list-inside mb-3">
                        ${playerListHTML}
                    </ul>
                `;
                groupCard.appendChild(infoDiv);

                // Skill Bar Div (at the bottom)
                const skillBarDiv = document.createElement('div');
                skillBarDiv.className = 'mt-auto'; // Push to bottom

                const barContainer = document.createElement('div');
                barContainer.className = 'group-skill-bar-container tooltip-container';

                const bar = document.createElement('div');
                bar.className = 'group-skill-bar';
                const barWidth = scaleMax > 0 ? (group.totalSkill / scaleMax) * 100 : 0;
                bar.style.width = `${Math.min(barWidth, 100)}%`; // Cap at 100%
                // bar.textContent = group.totalSkill; // Show total skill number on bar

                barContainer.appendChild(bar);

                 // Tooltip for the bar
                const tooltip = document.createElement('span');
                tooltip.className = 'tooltiptext';
                tooltip.textContent = `Total Skill: ${group.totalSkill}`;
                barContainer.appendChild(tooltip);


                skillBarDiv.appendChild(barContainer);
                groupCard.appendChild(skillBarDiv);

                groupDisplayDiv.appendChild(groupCard);
            });
        }

        function generateAndDisplayGroups() {
            const generatedGroups = generateGroups();
            displayGroups(generatedGroups);
        }

        // --- UI Update Trigger ---
        function updateOutingViewUI() {
            // Updates all relevant parts of the outing view UI
             if (currentViewMode !== 'outing' || !activeOutingId || !outings[activeOutingId]) return;
             const currentOuting = outings[activeOutingId];

            updateOutingPlayerList();

            numGroupsSlider.value = currentOuting.numberOfGroups;
            groupsValueSpan.textContent = currentOuting.numberOfGroups;
            numGroupsSlider.max = Math.max(1, currentOuting.playerNames.length || 1);

            displayGroups(currentOuting.groups); // Display stored/generated groups
        }

        // --- Utility Functions ---
        function showMessage(message, type = 'info') { // Default to info
            messageArea.textContent = message;
            messageArea.className = `mt-6 text-center font-medium ${
                type === 'error' ? 'text-red-600' :
                type === 'success' ? 'text-green-600' :
                'text-blue-600' // Default info
            }`;
            // Auto-clear non-error messages
            if (type !== 'error') {
                setTimeout(clearMessage, 3500);
            }
        }
        function clearMessage() { messageArea.textContent = ''; messageArea.className = 'mt-6 text-center font-medium'; }

        // --- Event Listeners Setup ---
        function setupEventListeners() {
            // Tab Switching
            managePlayersTabBtn.addEventListener('click', () => setActiveView(PLAYER_MGMT_VIEW_ID));
            addOutingBtn.addEventListener('click', createNewOuting);

            // Outing View: Player Search & Add
            playerSearchInput.addEventListener('input', handlePlayerSearch);
            document.addEventListener('click', (event) => { // Hide search results on outside click
                if (!playerSearchInput.contains(event.target) && !searchResultsDiv.contains(event.target)) {
                    hideSearchResults();
                     if (!playerSearchInput.value.trim()) hideAddNewPlayerSection();
                }
            });
            newPlayerSkillSlider.addEventListener('input', () => { newSkillValueSpan.textContent = newPlayerSkillSlider.value; });
            addNewPlayerBtn.addEventListener('click', addNewPlayerFromOutingView);

            // Outing View: Group Config
            numGroupsSlider.addEventListener('input', () => {
                groupsValueSpan.textContent = numGroupsSlider.value;
                 if (currentViewMode === 'outing' && activeOutingId && outings[activeOutingId]) {
                    outings[activeOutingId].numberOfGroups = parseInt(numGroupsSlider.value, 10);
                    saveData(); // Save setting, but don't regen yet
                 }
            });
            shakeUpBtn.addEventListener('click', generateAndDisplayGroups);

            // Player Management View: Add Player
            mgmtPlayerSkillSlider.addEventListener('input', () => { mgmtSkillValueSpan.textContent = mgmtPlayerSkillSlider.value; });
            mgmtAddPlayerBtn.addEventListener('click', handleAddPlayerFromMgmt);
             mgmtPlayerNameInput.addEventListener('keypress', (event) => {
                 if (event.key === 'Enter') {
                     handleAddPlayerFromMgmt();
                 }
             });
        }

        // Make functions called by inline handlers globally accessible
        // (Though it's better practice to attach listeners directly in JS)
        window.removePlayerFromOuting = removePlayerFromOuting; // Used in updateOutingPlayerList
        window.editPlayerSkillFromMgmt = editPlayerSkillFromMgmt; // Used in renderPlayerManagementView
        window.deletePlayerFromDatabase = deletePlayerFromDatabase; // Used in renderPlayerManagementView
        window.editOutingName = editOutingName; // Called from renderTabs

        // --- Start the application ---
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>

</body>
</html>
